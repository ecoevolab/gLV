---
title: "Exp04"
author: "Manuel Rivera"
date: "2025-03-04"
output: 
  html_document:
    toc: true           # Enable Table of Contents
    theme: sandstone
    toc_float: true
    collapsed: false
    smooth_scroll: true
---

## Generate parameters 

### Attach Packages
```{r}
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(tidyverse))

# For cluster environment, use the appropriate path: 
# library(tidyverse, lib.loc = "/mnt/atgc-d3/sur/modules/pkgs/tidyverse_mrc")

```

### Generate grid and save it

Create a grid of parameters.

- Species counts (`n_species`)
- Normal distribution mean (`Norm_mu`)
- Normal distribution standard deviation (`sigma`)
- No interaction probability (`p_noint`)
- Seed for initial population (`x0_seed`)
- Seed for growth rates population  (`mu_seed`)
- Seed for interactions  (`A_seed`)
```{r}
param.generate.fun <- function() {
  n_species <- rep(c(10, 100), times = 10)
  
  grid <- expand_grid(
    n_species = n_species,
    Norm_mu = 0,
    sigma = seq(0.005, 1, 0.05),
    p_noint = seq(0, 1, 0.05)
  )
  
  grid %>%
    mutate(
      id = ids::random_id(nrow(grid), bytes = 4),
      x0_seed = sample(1:1e6, nrow(grid), replace = FALSE),
      mu_seed = sample(1:1e6, nrow(grid), replace = FALSE),
      A_seed = sample(1:1e6, nrow(grid), replace = FALSE),
      diagonal = -0.5
    )
}

params.to.sim <- param.generate.fun()
head(params.to.sim)

```

Save the grid if the ids are unique
```{r, eval=FALSE}
# Check if there are any duplicate IDs
if (nrow(params.to.sim) != length(unique(params.to.sim$id))) {
  # Regenerate parameters if there are duplicated IDs
  repeat {
    params.to.sim <- param.generate.fun()
     if (nrow(params.to.sim) == length(unique(params.to.sim$id))) {
      # Save parameters once valid
      Params_path <- "/mnt/atgc-d3/sur/users/mrivera/glv-research/Data/Exp04-NormalD.tsv"
      if (!file.exists(Params_path)) {
        data.table::fwrite(params.to.sim, Params_path, sep = "\t")
        message("Parameters successfully saved to: ", Params_path)
        } else {
          message("File already exist. Verify path...\n")
          break  # Exit loop once saved
        }
      }
  warning("Duplicate IDs detected. Parameters not saved.")
  }
} else {
  # Save parameters if no duplicates
  Params_path <- "/mnt/atgc-d3/sur/users/mrivera/glv-research/Data/Exp04-NormalD.tsv"
  if (!file.exists(Params_path)) {
    data.table::fwrite(params.to.sim, Params_path, sep = "\t")
    message("Parameters successfully saved to: ", Params_path)
  } else {
    message("File already exist. Verify path...\n")
  }
}
```

```{r}
tmp <- nrow(params.to.sim) == length(unique(params.to.sim$id))
cat("Are the IDs unqiue?", tmp)
```

## Verify parameters

```{r}
# Source the function
source("/home/rivera/Cluster/glv-research/GIT-gLV/Method2-normal/generate-gLV-normal.R")

# For cluster environment, use the appropriate path: 
# source("/mnt/atgc-d3/sur/users/mrivera/glv-research/GIT-gLV/Method2-normal/generate-gLV-normal.R")
print(regenerate_Dnormal)
```


```{r}
# Source the function
params_table <- data.table::fread("/home/rivera/Cluster/glv-research/Data/Exp04-NormalD.tsv")

# For cluster environment, use the appropriate path: 
# params_table <- data.table::fread("/mnt/atgc-d3/sur/users/mrivera/glv-research/Data/Exp04-NormalD.tsv")
head(params_table)
```


```{r}
# Calculate the observed null and negative probability.
tmp <-  lapply(1:nrow(params_table), function(i) {
    
    # cat("Starting simulation ", i,"...\n")
    p <- regenerate_Dnormal(params_table[i,]) # Regenerate the parameters
  
    # Get non-diagonal elements in one step
    non_diag_elements <- p$M[row(p$M) != col(p$M)]
    
    # Efficiently compute proportions using mean (avoids explicit sums)
    p_neg_obs <- mean(non_diag_elements < 0)
    p_noint_obs <- mean(non_diag_elements == 0)
    
    # Return named vector
    return(c(p_neg_obs = p_neg_obs, 
             p_noint_obs = p_noint_obs))
})

res <- unlist(tmp)
tmp_df <- as.data.frame(matrix(res, ncol = 2, byrow = TRUE))
colnames(tmp_df) <- unique(names(res))

head(tmp_df)
```

```{r}
suppressPackageStartupMessages(library(dplyr))

error.df <- params_table %>%
  select(n_species, Norm_mu, sigma, p_noint) %>% # select columns of interest
  bind_cols(tmp_df) %>%  # Negative and Null oserved probabilities 
  group_by(Norm_mu, sigma, p_noint) %>%
  summarize(
  Total_specs = sum(n_species), # Calculate total number of species
  Sims_done = n(),  # Count total simulations done with the combination of parameters
  er_noint = p_noint_obs - p_noint) 
   

head(error.df)
```


Create graph:
```{r}
suppressPackageStartupMessages(library(ggplot2))

p1 <- error.df %>%
  ggplot(aes(x = p_noint, y = er_noint)) +
  geom_point() +
  geom_hline(yintercept = 0, col = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))

p1
```



## Generate plots of failed simulations

Load parameters table and NA counting table
```{r}
# ==== Load data====

# Load NA table
NA.table <- read.delim("/home/rivera/Cluster/glv-research/Results/Exp04-NormalD/Nas-counting.tsv", 
           sep = "\t", header = TRUE)

# For cluster environment, use the appropriate path: 
# NA.table <- read.delim("/mnt/atgc-d3/sur/users/mrivera/glv-research/Results/Exp04-NormalD/Nas-counting.tsv", sep = "\t", header = TRUE)
```

Join parameters by id
```{r}
# ==== Join tables====
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(plotly))

# Function to process and summarize data
summed_ode <- NA.table %>% 
    mutate(across(-1, ~ if_else(. > 0, 1, .))) %>% # Convert to 0's or 1's
    # Join parameters
    full_join(params_table %>% select(n_species, id, sigma, p_noint), by = "id") %>%
    mutate(across(c(sigma, p_noint), ~ round(.x, 4))) %>%
    group_by(sigma, p_noint, n_species) %>%
    summarize(
      n_failed = sum(Total.NAs != 0, na.rm = TRUE), # Failed simulations
      n_ran = sum(Total.NAs == 0, na.rm = TRUE),
      n_total = n(), # Count total simulations in each group
      run_props = n_ran/n_total # Runned simulations
    )


head(summed_ode)
```

Declare function for creating blackbox on every panel.
```{r}
#' Blackbox theme
#' 
#' ggplot2 theme that places a black margin on every
#' panel
#'
#' @param border.size Thickness of the margin.
#'
#' @return A \code{theme gg} object.
#' @export
#' @author Sur Herrera Paredes
theme_blackbox <- function(border.size = 3){
  theme(axis.text = element_text(color="black"),
        axis.title = element_text(face="bold"),
        panel.background = element_rect(color = "black",
                                        size = border.size,
                                        fill = NA),
        panel.grid = element_blank())
}
```

Generate heat map plot.
```{r}
p1 <- summed_ode %>%
  ggplot(aes(x = sigma, y = p_noint)) + 
  facet_wrap(~ n_species) +
  geom_tile(aes(fill = run_props), color = "black") + 
  scale_fill_gradientn(colours = c("#fee8c8", "#e34a33"), values = c(0,1)) +
  theme_blackbox() +
  scale_x_continuous(breaks = seq(0.005, 1, 0.1)) +
  scale_y_continuous(breaks = seq(0, 1, 0.05))
p1
```

Save HeatMap
```{r}
ggsave("/home/rivera/Pictures/glv-Graphs/Exp04-HMrunned.svg", width = 6, height = 4)
```
