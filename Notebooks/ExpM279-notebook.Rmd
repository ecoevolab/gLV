---
title: "ExpM279 notebook"
author: "Manuel Rivera"
date: "2025-03-04"
output: 
  html_document:
    toc: true           # Enable Table of Contents
    theme: sandstone
    toc_float: true
    collapsed: false
    smooth_scroll: true
---

## Generate parameters 

### Attach Packages
```{r}
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(tidyverse))

# For cluster environment, use the appropriate path: 
# library(tidyverse, lib.loc = "/mnt/atgc-d3/sur/modules/pkgs/tidyverse_mrc")

```

### Generate grid and save it

Create a grid of parameters.

- Species counts (`n_species`)
- Normal distribution mean (`Norm_mu`)
- Normal distribution standard deviation (`sigma`)
- No interaction probability (`p_noint`)
- Seed for initial population (`x0_seed`)
- Seed for growth rates population  (`mu_seed`)
- Seed for interactions  (`A_seed`)
```{r, eval=FALSE}
param.generate.fun <- function() {
  n_species <- rep(c(10, 30, 100), times = 10)
  
  grid <- expand_grid(
    n_species = n_species,
    Norm_mu = 0,
    sigma = seq(from = 1, to = 20, by = 0.5),
    p_noint = seq(from = 0, to = 1, by = 0.05)
  )
  
  grid %>%
    mutate(
      id = ids::random_id(nrow(grid), bytes = 4),
      x0_seed = sample(1:1e6, nrow(grid), replace = FALSE),
      mu_seed = sample(1:1e6, nrow(grid), replace = FALSE),
      A_seed = sample(1:1e6, nrow(grid), replace = FALSE),
      diagonal = -0.5
    )
}

params.to.sim <- param.generate.fun()
head(params.to.sim)

```

## Verify parameters

```{r}
# Source the function
source("/home/rivera/Cluster/glv-research/GIT-gLV/Method2-normal/generate-gLV-normal.R")

# For cluster environment, use the appropriate path: 
# source("/mnt/atgc-d3/sur/users/mrivera/glv-research/GIT-gLV/Method2-normal/generate-gLV-normal.R")
print(regenerate_Dnormal)
```


```{r}
# Source the function
params_table <- data.table::fread("/home/rivera/Cluster/glv-research/Data/ExpM279-D06M03.tsv")

# For cluster environment, use the appropriate path: 
# params_table <- data.table::fread("/mnt/atgc-d3/sur/users/mrivera/glv-research/Data/Exp04-NormalD.tsv")
str(params_table)
```


```{r}
# Calculate the observed null and negative probability.
tmp <-  lapply(1:nrow(params_table), function(i) {
    
    # cat("Starting simulation ", i,"...\n")
    p <- regenerate_Dnormal(params_table[i,]) # Regenerate the parameters
  
    # Get non-diagonal elements in one step
    non_diag_elements <- p$M[row(p$M) != col(p$M)]
    
    # Efficiently compute proportions using mean (avoids explicit sums)
    p_neg_obs <- mean(non_diag_elements < 0)
    p_noint_obs <- mean(non_diag_elements == 0)
    inters_vals <- non_diag_elements
    
    # Return named vector
    tibble(id = p$id,
                p_neg_obs = p_neg_obs, 
                p_noint_obs = p_noint_obs,
                values = list(inters_vals)
    )
})


df.result <- bind_rows(tmp)

glimpse(df.result)
```

```{r}
suppressPackageStartupMessages(library(dplyr))

error.df <- params_table %>%
  select(id, n_species, Norm_mu, sigma, p_noint) %>% # select columns of interest
  full_join(df.result, by = join_by(id)) %>%  # Negative and Null oserved probabilities 
  group_by(Norm_mu, sigma, p_noint, n_species) %>%
  summarize(values = list(unlist(values)), 
            Sims_done = n(),  # Count total simulations done with the combination of parameters
            er_noint = p_noint_obs - p_noint
  )
   

head(error.df)
```


Create graph:
```{r}
suppressPackageStartupMessages(library(ggplot2))

p1 <- error.df %>%
  ggplot(aes(x = p_noint, y = er_noint)) +
  geom_point() +
  geom_hline(yintercept = 0, col = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))

p1
```

```{r}

p2 <- error.df %>%
  filter(sigma %% 1 == 0) %>%  # Filters rows where the value is an integer (no decimals)
  ggplot(aes(x = str_sum)) +
  facet_grid(p_noint ~ sigma, labeller = labeller(p_noint = label_wrap_gen(width = 10), sigma = label_wrap_gen(width = 10))) +  # Wrap text for better readability
  geom_histogram(bins = 10, fill = "steelblue", color = "black") +  # Improved bin count and colors
  geom_vline(xintercept = 0, col = "red", linetype = "dashed") +  # Dashed red line at x = 0
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5),
    strip.background = element_blank(),  # Cleaner facet labels
    strip.text = element_text(face = "bold")
  ) +
  labs(
    x = "Interaction Strength (str_sum)",
    y = "Frequency",
    title = "Distribution of Interaction Strength by p_noint and sigma"
  )


print(p2)

```


## Generate plots of failed simulations

Load parameters table and NA counting table
```{r}
# ==== Load data====

# Load NA table
NA.table <- data.table::fread("/home/rivera/Cluster/glv-research/Results/ExpM279-D06M03/Nas-counting.tsv")

# For cluster environment, use the appropriate path: 
# NA.table <- read.delim("/mnt/atgc-d3/sur/users/mrivera/glv-research/Results/Exp04-NormalD/Nas-counting.tsv", sep = "\t", header = TRUE)

head(NA.table)
```

Join parameters by id
```{r}
# ==== Join tables====
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(plotly))

# Function to process and summarize data
summed_ode <- NA.table %>% 
    mutate(across(-1, ~ if_else(. > 0, 1, .))) %>% # Convert to 0's or 1's
    # Join parameters
    full_join(params_table %>% select(n_species, id, sigma, p_noint), by = "id") %>%
    mutate(across(c(sigma, p_noint), ~ round(.x, 4))) %>%
    group_by(sigma, p_noint, n_species) %>%
    summarize(
      n_failed = sum(Total.NAs != 0, na.rm = TRUE), # Failed simulations
      n_ran = sum(Total.NAs == 0, na.rm = TRUE),
      n_total = n(), # Count total simulations in each group
      run_props = n_ran/n_total # Runned simulations
    )


head(summed_ode)
```

Declare function for creating blackbox on every panel.
```{r}
#' Blackbox theme
#' 
#' ggplot2 theme that places a black margin on every
#' panel
#'
#' @param border.size Thickness of the margin.
#'
#' @return A \code{theme gg} object.
#' @export
#' @author Sur Herrera Paredes
theme_blackbox <- function(border.size = 3){
  theme(axis.text = element_text(color="black"),
        axis.title = element_text(face="bold"),
        panel.background = element_rect(color = "black",
                                        size = border.size,
                                        fill = NA),
        panel.grid = element_blank())
}
```

Generate heat map plot.
```{r}
p1 <- summed_ode %>%
  ggplot(aes(x = sigma, y = p_noint)) + 
  facet_wrap(~ n_species) +
  geom_tile(aes(fill = run_props), color = "black") + 
  scale_fill_gradientn(colours = c("#fee8c8", "#e34a33"), values = c(0,1)) +
  theme_blackbox() +
  scale_x_continuous(breaks = seq(from = 1, to = 20, by = 1)) +
  scale_y_continuous(breaks = seq(0, 1, 0.05))
p1
```

Save HeatMap
```{r}
ggsave("/home/rivera/Pictures/glv-Graphs/ExpM279-HMrunned.svg", width = 6, height = 4)
```
