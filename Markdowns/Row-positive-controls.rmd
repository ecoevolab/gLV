---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
# Purpose
This markdown is to summary and analyze the control experiment `exp_20251125`. Logs can be found at `59539`.

Keystone specie was set as:
+ Diagonal was set at **-0.5**.
+ Non zero off diagonal elements were sampled from a **-U(0,1)**.
+ *Keystone row* was set as **U(0.8,1)**.

# Rerun plots

I am not really sure about my data so I will plot the graphs again.
```{r, eval=FALSE}

dir = '/mnt/data/sur/users/mrivera/Controls/exp_20251125'
simulation_parameters = data.table::fread(paste0(dir, "/Simulation-parameters.tsv"), select = c("id", "keys", "p_noint"))
total_rows = nrow(simulation_parameters) * 30

ext_dir = '/mnt/data/sur/users/mrivera/Controls/exp_20251125/GNN-targets'
raw_outs_dir = '/mnt/data/sur/users/mrivera/Controls/exp_20251125/raw-ODEs'

library(dplyr)
library(parallel)

process_row <- function(i) {
  #------------------------
  # Generate path
  row <- simulation_parameters[i, ]
  id <- row$id
  key <- as.numeric(row$key)
  p_noint <- as.numeric(row$p_noint)
  ext_file_path <- paste0(ext_dir, paste0("/tgt_", id, ".feather"))
  ode_file_path <- paste0(raw_outs_dir, paste0("/O_", id, ".feather"))
  #------------------------
  # Generate relative abundance
  population <- arrow::read_feather(ode_file_path, col_select = 1000)
  relative_pop <- population / sum(population)
  #------------------------
  # Read extinctions file
  cols <- c("new_ext", "BC_diss", "K_s")
  table <- arrow::read_feather(ext_file_path, col_select = all_of(cols)) %>%
    rename(n_extinctions = new_ext) %>%
    rename(dissimilarity = BC_diss) %>%
    rename(keystoneness = K_s) %>%
    mutate(pop_initial = population[[1]]) %>%
    mutate(rel_pop_initial = relative_pop[[1]]) %>%
    mutate(prop_extinctions = n_extinctions / n()) %>%
    mutate(is_keystone = FALSE, p_noint = p_noint)
  # Add keystone
  table$is_keystone[key] <- TRUE
  table
}

results <- mclapply(1:nrow(simulation_parameters), process_row, mc.cores = detectCores() - 1)
full_summary <- do.call(rbind, results)

#-----------------------
# Section: Convert to long format.
library(tidyr)
full_summary_long <- full_summary %>%
    pivot_longer(
        cols = c(keystoneness, dissimilarity, n_extinctions, pop_initial, prop_extinctions, rel_pop_initial),
        names_to = "variable",
        values_to = "value"
    ) %>%
    dplyr::mutate(value = replace_na(value, 0))


#-----------------------
# Section: Generate directory for plots
plt_dir = paste0('/mnt/data/sur/users/mrivera/Plots/', basename(dir))
if (!(dir.exists(plt_dir))) { 
  dir.create(plt_dir)
  print('>> Directory created\n')}
```

# Generate correlations
```{r, eval=FALSE}
# Correlation analysis
full_summary[is.na(full_summary)] <- 0

library(GGally)
cols = c("keystoneness", "dissimilarity", "prop_extinctions", "rel_pop_initial")
plt = GGally::ggpairs(full_summary, columns = cols, title = "Correlation Analysis", upper = list(continuous = "cor"), lower = list(continuous = "points")) 
plt_dir = '/mnt/data/sur/users/mrivera/Plots/exp_20251125'
path = paste0(plt_dir, "/Correlation_Analysis.png")
ggsave(path, plot = plt, width = 8, height = 6)
```

# Metrics distribution by keystone status

```{r, eval=FALSE}
library(ggplot2)
library(patchwork)  # Better than cowplot for this

# Define common theme and colors
theme_custom <- theme_minimal(base_size = 12) +
    theme(
        legend.position = "bottom",
        plot.title = element_text(face = "bold", size = 11),
        axis.title = element_text(size = 10)
    )

colors <- c("FALSE" = "#4575b4", "TRUE" = "#d73027")  # Better color contrast

# Only plot these variables
variables_to_plot <- c("keystoneness", "dissimilarity", "prop_extinctions")

plots <- lapply(variables_to_plot, function(var) {
  data_subset <- full_summary_long[full_summary_long$variable == var, ]
  ggplot(data_subset, aes(x = is_keystone, y = value, fill = is_keystone)) +
    # geom_boxplot(alpha = 0.7, outlier.shape = NA) +
    geom_violin(alpha = 0.6, trim = TRUE) +
    # geom_jitter(width = 0.1, alpha = 0.3, size = 0.5) +
    scale_y_continuous(breaks = seq(0, 1, by = 0.1)) +
    # coord_flip() + 
    stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "red", color = "darkred") +
    scale_fill_manual(
      name = "", 
      values = colors, 
      labels = c("Non-keystone", "Keystone")
    ) +
    coord_cartesian(ylim = c(0, 1)) +
    theme_custom +
    labs(title = var, x = "", y = var) +
    theme(legend.position = "none", axis.text.x = element_blank())
})

plt = wrap_plots(plots, ncol = 3) & theme(legend.position = "top")
plt_dir = '/mnt/data/sur/users/mrivera/Plots/exp_20251125'
path = paste0(plt_dir, "/Metric_distributions.png")
ggsave(path, plot = plt, width = 12, height = 5)
```


# Plot Time to stability

```{r, eval=FALSE}

# Load information table
summary_path = '/mnt/data/sur/users/mrivera/Controls/exp_20251125/Summary-simulations.feather'
summary_table = arrow::read_feather(summary_path)

# Long format conversion
library(tidyr)
library(ggplot2)
library(ggbeeswarm)
library(ggridges)
library(dplyr)

# Compute means
means <- summary_table %>%
  pivot_longer(cols = c(tts_out, tts_ext), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  summarise(mean_val = mean(value, na.rm = TRUE))

# Plot
plt = summary_table %>%
  pivot_longer(cols = c(tts_out, tts_ext), names_to = "variable", values_to = "value") %>%
  ggplot(aes(x = value, y = factor(variable), fill = factor(variable))) +
  geom_density_ridges(alpha = 0.7) +
  geom_vline(data = means, aes(xintercept = mean_val, color = variable), linetype = "dashed", linewidth = 1) +
  labs(x = "Value", y = "Variable", fill = "Variable", color = 'Variable') +
  scale_x_continuous(breaks = seq(0, 1000, by = 100), limits = c(0, 1000)) +
  theme_minimal()

path = '/mnt/data/sur/users/mrivera/Plots/exp_20251125/TTS_simulation.png'
ggsave(path, plot = plt, width = 12, height = 5)
```

# Plot keystone metrics vs keystone status
```{r, eval=FALSE}
library(ggplot2)
library(tidyr)

plt = full_summary %>%  filter('rel_pop_initial' > .05) %>% as.data.frame() %>%
  pivot_longer(cols = c(keystoneness, dissimilarity, prop_extinctions), names_to = "variable", values_to = "value") %>%
  ggplot(aes(x = rel_pop_initial, y = value, color = is_keystone)) +
  geom_point(alpha = 0.5, size = 0.5) +
  #geom_hex(bins = 50) +
  facet_grid(variable ~ is_keystone, scales = "free_y") +
  labs(x = "Relative Population", y = "Value", color = "Keystone specie") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkred") + # linear fit with confidence interval
  coord_cartesian(ylim = c(0, 1), xlim = c(0,1)) + 
  theme_bw()

path = '/mnt/data/sur/users/mrivera/Plots/exp_20251125/Correlations-Relabu.png'
ggsave(path, plot = plt, width = 12, height = 5)
```

# Count the number of keystones that died 
```{r, eval=FALSE}

threshold = 1e-06
plt = full_summary_long %>%
  filter(variable == "rel_pop_initial") %>%
  group_by(is_keystone) %>%
  summarise(
    below = sum(value < threshold),
    above = sum(value >= threshold)
  ) %>%
  pivot_longer(cols = c(below, above), names_to = "status", values_to = "n") %>%
  group_by(is_keystone) %>%
  mutate(pct = n / sum(n) ) %>%
  ggplot(aes(x = is_keystone, y = pct, fill = status)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Keystone", y = "Number of species", fill = "Threshold") +
  theme_bw() +
  coord_cartesian(ylim = c(0, 1))

path = '/mnt/data/sur/users/mrivera/Plots/exp_20251125/Dead-analysis.png'
ggsave(path, plot = plt, width = 12, height = 5)
```